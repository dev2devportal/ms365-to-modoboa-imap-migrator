This is an earlier prototype with static variables hardcoded into the script, rather than separated out.
The scripts can only run one account at atime, rather than a list of accounts.
You must edit the variables near the top to make this work with your configuration.
Run the migration (download) script first.
Then only after that is complete, and you verify it looks like a complete replication, then run the upload script.
These are still imperfect, but help in the process of moving whole accounts.

# MS365 to Modoboa Migration Tools

Tools for migrating email accounts from Microsoft 365 Exchange Online to a self-hosted Modoboa server, preserving folder hierarchy and message integrity while preventing duplicates.

## Features

- Full folder hierarchy preservation
- Message deduplication
- Binary content handling
- Parallel download processing
- Secure handling of credentials
- Detailed logging and status tracking
- Resumable operations
- Dovecot-compatible folder structure

## Prerequisites

### System Requirements
- Linux environment (tested on Debian 12)
- Azure CLI (v2.68.0-1 or later)
- OpenSSL
- jq JSON processor
- Bash 4.4+

### Azure Setup
1. Create an Azure AD Application Registration
2. Add required permissions:
   - Mail.Read.All
   - Mail.ReadWrite.All
   - User.Read.All
3. Create a client secret
4. Note the following values:
   - Application (client) ID
   - Directory (tenant) ID
   - Client secret

### Modoboa Server
- Modoboa 2.3.4 or later
- Dovecot 2.3.21.1 or later
- SSL/TLS enabled on IMAP (port 993)

## Installation

1. Clone the repository:
```bash
git clone https://github.com/yourusername/ms365-modoboa-migration.git
cd ms365-modoboa-migration
```

2. Make scripts executable:
```bash
chmod +x migration-script-v29.0.4.sh
chmod +x upload-to-modoboa-imap-v42.0.11.sh
```

3. Create configuration file:
```bash
cp config.yaml.example config.yaml
chmod 600 config.yaml
```

4. Edit configuration:
```yaml
azure:
  client_id: "your-client-id"
  tenant_id: "your-tenant-id"
  client_secret: "your-client-secret"
  subscription_id: "your-subscription-id"

modoboa:
  server: "mail.yourdomain.com"
  port: 993
  ssl: true
```

## Directory Structure
The messages, stats, config, and logs directories should be autogenerated by running the scripts.
The exact directory tree might vary from version to verion in the prototype versions until this becomes more standardized and stabilized in the more complete versions.


```plaintext
ms365-modoboa-migration/
├── scripts/
│   ├── migration-script-v29.0.4.sh
│   └── upload-to-modoboa-imap-v42.0.11.sh
├── config/
│   └── config.yaml
├── messages/
│   └── [email folders and messages]
├── stats/
│   ├── folders/
│   ├── jobs/
│   ├── locks/
│   └── message_cache/
└── logs/
    ├── migration.log
    └── upload.log
```

## Usage

### Single User Migration -- Verified Working in Production Environments

1. Download phase:
```bash
./migration-script-v29.0.4.sh \
    --user user@domain.com \
    --config config.yaml
```

2. Upload phase:
```bash
./upload-to-modoboa-imap-v42.0.11.sh \
    --user user@domain.com \
    --config config.yaml
```

### Bulk Migration -- NOT COMPLETE -- NOT VERIFIED IN PRODUCTION

1. Create users file:
```bash
cat > users.txt << EOL
user1@domain.com
user2@domain.com
user3@domain.com
EOL
```

2. Run bulk migration:
```bash
./bulk-migration.sh users.txt config.yaml
```

## Monitoring

### Check Progress

1. View download progress:
```bash
tail -f logs/migration.log
```

2. View upload progress:
```bash
tail -f logs/upload.log
```

3. Check statistics:
```bash
cat stats/total_messages  # Total messages downloaded
cat stats/total_size     # Total size downloaded
cat stats/total_failed   # Failed downloads
```

### Monitor Resources

```bash
# Check disk usage
du -sh messages/
du -sh stats/

# Check active processes
ps aux | grep migration-script
ps aux | grep upload-to-modoboa
```

## Troubleshooting

### Common Issues

1. Authentication Failures
```bash
# Test Azure authentication
./test-azure-auth.sh

# Test IMAP authentication
./test-imap-auth.sh
```

2. Folder Creation Issues
```bash
# List existing folders
./list-imap-folders.sh user@domain.com

# Verify folder hierarchy
./verify-folder-structure.sh user@domain.com
```

3. Message Upload Failures
```bash
# Check failed uploads
cat stats/upload_total_failed

# Retry failed uploads
./retry-failed-uploads.sh
```

### Error Recovery

1. Clear stale locks:
```bash
./cleanup-locks.sh
```

2. Resume interrupted migration:
```bash
# Resume download
./migration-script-v29.0.4.sh --resume

# Resume upload
./upload-to-modoboa-imap-v42.0.11.sh --resume
```

## Performance Tuning

### Download Phase
```bash
# Adjust parallel downloads
export MAX_PARALLEL_DOWNLOADS=3

# Adjust delays
export REQUEST_DELAY=0.5
export RETRY_DELAY=5
```

### Upload Phase
```bash
# Adjust retry settings
export MAX_RETRIES=2
export VERIFY_DELAY=1
```

## Security Considerations

1. File Permissions
```bash
# Secure config file
chmod 600 config.yaml

# Secure credentials
chmod 600 credentials.txt

# Set directory permissions
chmod 755 messages stats logs
```

2. Network Security
- All connections use SSL/TLS
- Certificate verification enabled
- Hostname verification required

3. Credential Handling
- No plaintext storage
- Runtime-only memory usage
- Secure cleanup

## Maintenance

### Log Rotation
```bash
# Rotate logs
./rotate-logs.sh

# Archive old logs
tar czf logs-$(date +%Y%m%d).tar.gz logs/
```

### Cleanup
```bash
# Remove temporary files
./cleanup-temp.sh

# Archive completed migrations
./archive-migration.sh user@domain.com
```

## Contributing

1. Fork the repository
2. Create your feature branch
3. Commit your changes
4. Push to the branch
5. Create a Pull Request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- Modoboa team for their excellent email server
- Microsoft Graph API documentation
- Azure CLI team
- All contributors to this project

## Support

For bugs and feature requests, please open an issue on GitHub.

## FAQ

### Q: How long does migration take?
A: Migration time depends on mailbox size and message count. Expect roughly:
- Small mailbox (< 1GB): 1-2 hours
- Medium mailbox (1-10GB): 2-6 hours
- Large mailbox (> 10GB): 6+ hours

### Q: Can I migrate multiple users simultaneously?
A: Yes, but monitor system resources. Recommended maximum is 3-4 simultaneous migrations.

### Q: What happens if migration is interrupted?
A: The scripts support resuming from the last successful point using the --resume flag.

### Q: How are duplicates handled?
A: Messages are identified by Message-ID headers or content hash. Duplicates are automatically skipped.

### Q: Are message flags preserved?
A: Basic flags (read/unread) are preserved. Custom flags may not transfer.

## Version History

- v29.0.4 (Download Script)
  - Added folder hierarchy preservation
  - Improved error handling
  - Fixed pagination issues

- v42.0.11 (Upload Script)
  - Added Dovecot folder support
  - Fixed duplicate detection
  - Improved nested folder handling

## Contact

Project Maintainer: Hawke Robinson
GitHub: https://github.com/dev2devportal/